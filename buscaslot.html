<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slot Price Scout | Price Hunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Orbitron', sans-serif; background-color: #050718; color: #d1d5db; }
        :root { --neon-color: #3b82f6; --neon-shadow: 0 0 8px rgba(59, 130, 246, 0.8); --price-neon-color: #38bdf8; }
        .neon-title { color: #dbeafe; text-shadow: 0 0 4px var(--neon-color); letter-spacing: 0.1em; }
        .neon-card { background-color: #111827; border: 2px solid var(--neon-color); box-shadow: var(--neon-shadow); }
        .neon-button { background-color: var(--neon-color); color: #111827; font-weight: 700; transition: all 0.2s; }
        .neon-button:hover:not(:disabled) { background-color: #60a5fa; transform: translateY(-2px); box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }
        .neon-button:disabled { opacity: 0.4; cursor: not-allowed; }
        .neon-stat-box { background-color: #1e293b; border: 3px solid var(--price-neon-color); box-shadow: 0 0 10px rgba(56, 189, 248, 0.9); }
        .neon-price { color: var(--price-neon-color); text-shadow: 0 0 5px #0ea5e9; }
        #cameraStream { width: 100%; aspect-ratio: 4/3; object-fit: cover; }
        #cameraCanvas { display: none; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-lg p-6 mb-8 text-center rounded-2xl shadow-xl">
        <h1 class="text-3xl font-extrabold mb-1 neon-title">SLOT PRICE SCOUT</h1>
        <p class="text-xs opacity-70 tracking-widest text-blue-300">CONECTADO A GOOGLE SEARCH</p>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-lg">

        <!-- Upload Card -->
        <div id="upload-card" class="neon-card p-6 rounded-2xl mb-6">
            <h2 class="text-xl font-bold text-blue-300 mb-4">1. ESCANEAR COCHE</h2>
            
            <div id="initialOptions" class="space-y-4">
                <button id="cameraButton" class="w-full py-3 bg-blue-700 text-white font-semibold rounded-xl hover:bg-blue-600 transition flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.125 4h3.75a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>USAR C√ÅMARA</span>
                </button>
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <button id="uploadFileButton" class="w-full py-3 bg-gray-700 text-gray-200 font-semibold rounded-xl hover:bg-gray-600 transition flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>SUBIR FOTO</span>
                </button>
            </div>
            
            <div id="cameraSection" class="hidden">
                <div class="relative w-full rounded-xl overflow-hidden border-2 border-blue-500">
                    <video id="cameraStream" autoplay playsinline class="rounded-xl"></video>
                    <canvas id="cameraCanvas"></canvas>
                </div>
                <div class="flex space-x-2 mt-4">
                    <button id="captureButton" class="flex-grow py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600">FOTO</button>
                    <button id="cancelCaptureButton" class="py-3 px-6 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700">X</button>
                </div>
            </div>

            <div id="imagePreviewContainer" class="mt-4 hidden">
                <img id="imagePreview" class="w-full h-auto max-h-64 object-contain rounded-xl border-2 border-gray-700 shadow-xl">
                <button id="changePhotoButton" class="mt-3 w-full py-2 bg-yellow-600 text-gray-900 font-semibold rounded-xl hover:bg-yellow-500">CAMBIAR FOTO</button>
            </div>

            <button id="searchButton" onclick="startGeminiSearch()" class="neon-button mt-4 w-full py-3 font-bold rounded-2xl opacity-50 cursor-not-allowed" disabled>
                <span id="buttonText">ANALIZAR MERCADO</span>
            </button>
        </div>

        <div id="results-card" class="neon-card p-6 rounded-2xl hidden relative overflow-hidden">
            <h2 class="text-xl font-bold text-blue-300 mb-4">2. INFORME DE VALOR</h2>
            
            <div id="loadingIndicator" class="text-center py-8 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p id="loadingMessage" class="text-blue-400 font-medium text-sm animate-pulse">RASTREANDO PRECIOS...</p>
            </div>

            <div id="resultsContent" class="hidden">
                <div class="mb-6 p-4 bg-gray-800/50 rounded-xl border border-blue-500/30">
                    <p class="text-xs text-blue-400 font-bold uppercase">Modelo Identificado</p>
                    <p id="identifiedCar" class="text-xl font-bold text-white mt-1 leading-tight"></p>
                </div>
                <div class="flex justify-center text-center mb-6">
                    <div class="neon-stat-box p-5 rounded-2xl w-full">
                        <p class="text-xs font-bold text-blue-300 uppercase tracking-widest">Valor Estimado</p>
                        <p id="marketPrice" class="neon-price text-4xl font-extrabold mt-2 my-2">-- ‚Ç¨</p>
                        <p id="priceNote" class="text-xs text-gray-500 italic">Basado en listings actuales</p>
                    </div>
                </div>
                <div class="bg-black/30 p-4 rounded-xl border border-gray-700">
                    <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">Detalles:</h3>
                    <p id="geminiAnalysis" class="text-sm text-gray-300 leading-relaxed"></p>
                    <div id="groundingSources" class="mt-4 pt-3 border-t border-gray-700 space-y-2 hidden"></div>
                </div>
            </div>
        </div>

        <!-- Panel de Error Detallado -->
        <div id="errorMessage" class="hidden mt-4 p-4 bg-red-900/90 border-2 border-red-500 text-white rounded-xl text-xs font-mono break-words shadow-lg"></div>
    </main>
</div>

<script type="module">
    // üõ°Ô∏è CLAVE API CAMUFLADA üõ°Ô∏è
    const KEY_PART_A = "AIzaSyDqDbLI8aRv";
    const KEY_PART_B = "wsFCEX__9F52iMiVmWJAtAc";
    const GEMINI_API_KEY = KEY_PART_A + KEY_PART_B;
    
    // Modelo estable
    const MODEL_VERSION = "gemini-2.5-flash-preview-09-2025"; 
    
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_VERSION}:generateContent?key=${GEMINI_API_KEY}`;

    let base64Image = null;
    let mediaStream = null; 

    const els = {
        imageInput: document.getElementById('imageInput'),
        imagePreview: document.getElementById('imagePreview'),
        imagePreviewContainer: document.getElementById('imagePreviewContainer'),
        searchButton: document.getElementById('searchButton'),
        resultsCard: document.getElementById('results-card'),
        loadingIndicator: document.getElementById('loadingIndicator'),
        resultsContent: document.getElementById('resultsContent'),
        errorMessage: document.getElementById('errorMessage'),
        initialOptions: document.getElementById('initialOptions'),
        cameraSection: document.getElementById('cameraSection'),
        cameraStream: document.getElementById('cameraStream'),
        cameraCanvas: document.getElementById('cameraCanvas'),
        identifiedCar: document.getElementById('identifiedCar'),
        marketPrice: document.getElementById('marketPrice'),
        geminiAnalysis: document.getElementById('geminiAnalysis'),
        groundingSources: document.getElementById('groundingSources')
    };

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                let encoded = reader.result.toString().replace(/^data:(.*,)?/, '');
                if ((encoded.length % 4) > 0) encoded += '='.repeat(4 - (encoded.length % 4));
                resolve(encoded);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    async function processMedia(media) {
        if (!media) return;
        try {
            const file = media instanceof File ? media : new File([media], 'captured.jpg', { type: 'image/jpeg' });
            els.imagePreview.src = URL.createObjectURL(file);
            els.imagePreviewContainer.classList.remove('hidden');
            els.initialOptions.classList.add('hidden');
            els.cameraSection.classList.add('hidden');
            els.resultsCard.classList.add('hidden');
            els.errorMessage.classList.add('hidden');
            
            base64Image = await fileToBase64(file);
            els.searchButton.disabled = false;
            els.searchButton.classList.remove('opacity-50', 'cursor-not-allowed');
        } catch (error) {
            showError("Error procesando imagen: " + error.message);
        }
    }

    async function startCamera() {
        els.errorMessage.classList.add('hidden');
        els.initialOptions.classList.add('hidden');
        els.cameraSection.classList.remove('hidden');
        if (mediaStream) stopCamera();
        try {
            const constraints = { video: { facingMode: 'environment', width: { ideal: 1280 } } }; 
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
            els.cameraStream.srcObject = mediaStream;
        } catch (error) {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                els.cameraStream.srcObject = mediaStream;
            } catch (e) {
                showError('No se pudo acceder a la c√°mara. Comprueba permisos.');
                resetUI();
            }
        }
    }

    function stopCamera() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
    }

    function captureImage() {
        const video = els.cameraStream;
        const canvas = els.cameraCanvas;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        stopCamera();
        canvas.toBlob(blob => processMedia(blob), 'image/jpeg', 0.85);
    }

    // --- LLAMADA A GEMINI REFORZADA ---
    window.startGeminiSearch = async function () {
        if (!base64Image) return;

        els.resultsCard.classList.remove('hidden');
        els.loadingIndicator.classList.remove('hidden');
        els.resultsContent.classList.add('hidden');
        els.errorMessage.classList.add('hidden');
        els.searchButton.disabled = true;

        try {
            const promptText = `
                Eres un experto tasador de Scalextric/Slot.
                1. Analiza la imagen. Identifica Marca, Modelo y Referencia.
                2. Busca en Google precios actuales de segunda mano (eBay, Wallapop, Todocoleccion).
                3. Responde SOLAMENTE con este JSON:
                {
                   "car_name": "Nombre Exacto",
                   "price_text": "XX‚Ç¨ - XX‚Ç¨",
                   "analysis": "Explicaci√≥n breve"
                }
                IMPORTANTE: El campo 'price_text' DEBE contener un rango num√©rico (ej: '30‚Ç¨ - 40‚Ç¨'). NO pongas 'Ver fuentes'. Si no encuentras exacto, estima.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: promptText },
                        { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                    ]
                }],
                tools: [{ google_search: {} }]
            };

            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (data.error) throw new Error("API Error: " + data.error.message);

            const candidate = data.candidates?.[0];
            if (!candidate) throw new Error("No se recibi√≥ respuesta de Gemini.");

            const resultText = candidate.content.parts[0].text;
            
            // INTENTO DE PARSEO ROBUSTO
            let resultJson;
            try {
                // Buscamos el JSON limpio
                const firstBrace = resultText.indexOf('{');
                const lastBrace = resultText.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1) {
                    const jsonString = resultText.substring(firstBrace, lastBrace + 1);
                    resultJson = JSON.parse(jsonString);
                } else {
                    throw new Error("No JSON");
                }
            } catch (e) {
                console.warn("Fallo de parseo JSON. Usando extracci√≥n manual.");
                // Si el JSON falla, extraemos los datos "a lo bruto" con Regex del texto completo
                
                // Intentar sacar precio con Regex (busca n√∫meros seguidos de ‚Ç¨ o eur)
                const priceMatch = resultText.match(/(\d+(?:[\.,]\d+)?)\s?(?:‚Ç¨|eur)/i);
                const extractedPrice = priceMatch ? `${priceMatch[0]} aprox.` : "Consultar Links";
                
                resultJson = {
                    car_name: "Modelo Detectado",
                    price_text: extractedPrice,
                    analysis: resultText.replace(/```json|```/g, '').substring(0, 250) + "..."
                };
            }
            
            // Renderizar Fuentes
            const grounding = candidate.groundingMetadata;
            let sourcesHTML = '';
            if (grounding && grounding.groundingAttributions) {
                const uniqueLinks = new Set();
                grounding.groundingAttributions.forEach(att => {
                    if (att.web && att.web.uri && att.web.title) {
                        if (!uniqueLinks.has(att.web.uri)) {
                            uniqueLinks.add(att.web.uri);
                            sourcesHTML += `<a href="${att.web.uri}" target="_blank" class="block text-blue-400 hover:text-blue-300 truncate text-xs mb-2 border-b border-gray-700 pb-1">üîó ${att.web.title}</a>`;
                        }
                    }
                });
            }

            els.loadingIndicator.classList.add('hidden');
            els.resultsContent.classList.remove('hidden');
            
            els.identifiedCar.textContent = resultJson.car_name || "Modelo no identificado";
            els.marketPrice.textContent = resultJson.price_text || "Consultar";
            els.geminiAnalysis.textContent = resultJson.analysis || "Sin an√°lisis.";
            
            if (sourcesHTML) {
                els.groundingSources.innerHTML = sourcesHTML;
                els.groundingSources.classList.remove('hidden');
            } else {
                els.groundingSources.classList.add('hidden');
            }

        } catch (error) {
            console.error(error);
            showError("‚ö†Ô∏è ERROR: " + error.message);
        } finally {
            els.searchButton.disabled = false;
        }
    };

    function showError(msg) {
        els.errorMessage.textContent = msg;
        els.errorMessage.classList.remove('hidden');
        els.loadingIndicator.classList.add('hidden');
    }

    function resetUI() {
        els.initialOptions.classList.remove('hidden');
        els.cameraSection.classList.add('hidden');
        els.imagePreviewContainer.classList.add('hidden');
        els.resultsCard.classList.add('hidden');
        els.errorMessage.classList.add('hidden');
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('cameraButton').addEventListener('click', startCamera);
        document.getElementById('captureButton').addEventListener('click', captureImage);
        document.getElementById('cancelCaptureButton').addEventListener('click', resetUI);
        document.getElementById('uploadFileButton').addEventListener('click', () => els.imageInput.click());
        document.getElementById('changePhotoButton').addEventListener('click', resetUI);
        els.imageInput.addEventListener('change', (e) => processMedia(e.target.files?.[0]));
        resetUI();
    });
</script>

</body>
</html>
