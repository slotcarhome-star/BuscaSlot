<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Slot Price Scout | Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Orbitron', sans-serif; 
            background-color: #050718; 
            color: #d1d5db; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --neon-color: #3b82f6;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --neon-gold: #f59e0b;
        }

        .neon-title {
            color: #dbeafe; 
            text-shadow: 0 0 4px var(--neon-color), 0 0 8px #93c5fd; 
            letter-spacing: 0.1em;
        }

        .neon-card {
            background-color: #111827; 
            border: 1px solid #1e3a8a;
            box-shadow: 0 0 15px rgba(30, 58, 138, 0.3);
            transition: all 0.3s ease-in-out;
        }

        .neon-button {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #ffffff;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transition: transform 0.1s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .neon-button:active { transform: scale(0.98); }
        .neon-button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

        .stat-box {
            background-color: #0f172a; 
            border: 1px solid #334155;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .stat-box.min { border-color: var(--neon-green); box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.1); }
        .stat-box.max { border-color: var(--neon-red); box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.1); }
        
        .rec-box {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border: 1px solid var(--neon-gold);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.2);
            position: relative;
            overflow: hidden;
        }
        .rec-box::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(245,158,11,0.1) 0%, transparent 70%);
            animation: pulse-gold 3s infinite;
        }
        @keyframes pulse-gold { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .price-text { text-shadow: 0 0 10px currentColor; }

        #cameraStream {
            width: 100%; height: 60vh; max-height: 400px;
            object-fit: cover; background: #000; border-radius: 0.75rem;
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111827; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e40af; border-radius: 4px; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center w-full p-3 sm:p-4 pb-12">

    <!-- Header Limpio -->
    <header class="w-full max-w-lg p-4 mb-4 text-center rounded-2xl shadow-xl border border-blue-900/40 bg-gray-900/80 backdrop-blur-md sticky top-2 z-50">
        <h1 class="text-2xl sm:text-3xl font-black mb-0 neon-title italic truncate">SLOT PRICE SCOUT</h1>
        <p class="text-[10px] sm:text-xs text-gray-400 font-mono tracking-widest uppercase mt-1">Professional Edition</p>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-lg space-y-4 flex-grow">

        <!-- Input Card -->
        <div id="upload-card" class="neon-card p-4 sm:p-6 rounded-2xl fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-600 via-cyan-400 to-blue-600 opacity-50"></div>
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base sm:text-lg font-bold text-white flex items-center">
                    <span class="bg-blue-600 text-[10px] px-2 py-0.5 rounded mr-2 shadow-lg">PASO 1</span> 
                    CAPTURA
                </h2>
                <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-600 animate-pulse"></div>
            </div>
            
            <div id="initialOptions" class="grid grid-cols-2 gap-3">
                <button id="cameraButton" class="col-span-2 py-8 bg-gray-800 active:bg-gray-700 border border-gray-600 rounded-xl transition flex flex-col items-center justify-center group touch-manipulation">
                    <svg class="w-10 h-10 text-blue-400 mb-2 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.125 4h3.75a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-sm font-bold tracking-wider text-blue-100">ABRIR C√ÅMARA</span>
                </button>
                
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <button id="uploadFileButton" class="col-span-2 py-4 bg-gray-800 active:bg-gray-700 border border-gray-600 rounded-xl transition flex items-center justify-center space-x-2 touch-manipulation">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span class="text-xs font-semibold text-gray-300">SUBIR DESDE GALER√çA</span>
                </button>
            </div>
            
            <div id="cameraSection" class="hidden flex flex-col items-center">
                <div class="relative w-full rounded-xl overflow-hidden border-2 border-blue-500 shadow-2xl bg-black mb-4">
                    <video id="cameraStream" autoplay playsinline muted></video>
                    <canvas id="cameraCanvas" class="hidden"></canvas>
                    <div class="absolute inset-0 border-2 border-white/20 pointer-events-none">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3/4 h-1/2 border border-white/40 rounded-lg"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 w-full">
                    <button id="captureButton" class="py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition text-sm">CAPTURAR</button>
                    <button id="cancelCaptureButton" class="py-4 bg-red-900/80 text-red-200 font-bold rounded-xl border border-red-800 active:scale-95 transition text-sm">CANCELAR</button>
                </div>
            </div>

            <div id="imagePreviewContainer" class="hidden fade-in">
                <div class="relative group rounded-xl overflow-hidden border border-gray-600 bg-black aspect-video">
                    <img id="imagePreview" class="w-full h-full object-contain" alt="Vista previa">
                    <button id="changePhotoButton" class="absolute bottom-3 right-3 bg-black/80 text-white text-xs px-4 py-2 rounded-lg border border-white/20 active:bg-blue-600 transition shadow-lg backdrop-blur">Cambiar foto</button>
                </div>
            </div>

            <div class="mt-5 pt-4 border-t border-gray-800">
                <div class="flex justify-between items-center mb-4 px-1">
                    <div class="flex items-center space-x-2">
                         <span class="text-[10px] sm:text-xs text-gray-400 font-mono uppercase">Voz: <span id="voiceStatus" class="text-blue-400 font-bold">ON</span></span>
                    </div>
                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="voiceToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer -top-0" checked/>
                        <label for="voiceToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                    </div>
                </div>

                <button id="searchButton" onclick="startSearch()" class="neon-button w-full py-5 rounded-xl relative overflow-hidden group text-lg tracking-widest shadow-blue-900/20" disabled>
                    <span id="buttonText" class="relative z-10 flex items-center justify-center gap-2">ESPERANDO IMAGEN</span>
                </button>
            </div>
        </div>

        <!-- Results Card -->
        <div id="results-card" class="neon-card p-4 sm:p-6 rounded-2xl hidden fade-in">
            <h2 class="text-base sm:text-lg font-bold text-white mb-4 flex items-center">
                <span class="bg-green-600 text-[10px] px-2 py-0.5 rounded mr-2 shadow-lg">PASO 2</span> 
                VALORACI√ìN
            </h2>
            
            <div id="loadingIndicator" class="text-center py-12 hidden">
                <div class="flex justify-center items-center space-x-2 mb-4">
                    <div class="w-2 h-8 bg-blue-500 animate-[bounce_1s_infinite]"></div>
                    <div class="w-2 h-8 bg-blue-400 animate-[bounce_1.2s_infinite]"></div>
                    <div class="w-2 h-8 bg-blue-300 animate-[bounce_1.4s_infinite]"></div>
                </div>
                <p id="loadingMessage" class="text-blue-400 text-xs font-mono uppercase animate-pulse">Analizando imagen...</p>
            </div>

            <!-- ID + Condition -->
            <div id="carIdentification" class="mb-5 bg-gray-900/90 p-4 rounded-xl border-l-4 border-blue-500 hidden shadow-inner">
                <h3 id="identifiedCar" class="text-lg font-black text-white leading-tight"></h3>
                <div class="flex justify-between items-end mt-2">
                    <p id="carBrand" class="text-xs text-blue-400 font-bold uppercase tracking-wide"></p>
                    <span id="carCondition" class="text-[10px] bg-gray-800 px-2 py-1 rounded border border-gray-600 text-gray-300">Estado: --</span>
                </div>
            </div>

            <!-- Precios -->
            <div id="priceSummary" class="hidden fade-in mb-6">
                
                <!-- RECOMENDACI√ìN -->
                <div class="rec-box p-4 rounded-xl text-center mb-4 relative">
                    <p class="text-[10px] text-yellow-400 font-bold uppercase tracking-widest mb-1 z-10 relative">Precio Recomendado</p>
                    <p id="recPrice" class="text-4xl sm:text-5xl font-black text-white price-text z-10 relative my-2">--‚Ç¨</p>
                    <p class="text-[10px] text-yellow-200/70 z-10 relative italic">Basado en el estado visual detectado</p>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <!-- Min -->
                    <div class="stat-box min p-3 rounded-xl text-center">
                        <div class="mb-2">
                            <p class="text-[10px] text-green-400 font-bold uppercase tracking-wider">M√≠nimo</p>
                            <p id="minPrice" class="text-xl sm:text-2xl font-black text-white price-text my-1">--‚Ç¨</p>
                        </div>
                        <a id="minLink" href="#" target="_blank" class="hidden w-full py-2 bg-green-900/40 hover:bg-green-800 text-green-300 text-[10px] font-bold rounded border border-green-700/50 transition">VER ANUNCIO</a>
                    </div>
                    <!-- Max -->
                    <div class="stat-box max p-3 rounded-xl text-center">
                        <div class="mb-2">
                            <p class="text-[10px] text-red-400 font-bold uppercase tracking-wider">M√°ximo</p>
                            <p id="maxPrice" class="text-xl sm:text-2xl font-black text-white price-text my-1">--‚Ç¨</p>
                        </div>
                        <a id="maxLink" href="#" target="_blank" class="hidden w-full py-2 bg-red-900/40 hover:bg-red-800 text-red-300 text-[10px] font-bold rounded border border-red-700/50 transition">VER ANUNCIO</a>
                    </div>
                </div>
            </div>

            <div id="priceResults">
                <p id="noResults" class="text-gray-500 text-center py-6 text-sm hidden border border-dashed border-gray-700 rounded-xl bg-gray-900/50">
                    Sin coincidencias exactas.
                </p>
                
                <div id="sourcesContainer" class="hidden">
                    <h4 class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-3 mt-6 border-t border-gray-800 pt-4 text-center">Detalle de B√∫squeda</h4>
                    <div id="sourcesList" class="space-y-3 max-h-80 overflow-y-auto custom-scroll pr-1"></div>
                </div>
            </div>
        </div>

        <!-- Info -->
        <div class="mt-8 p-5 rounded-2xl border border-blue-900/30 bg-gray-900/40 text-center fade-in backdrop-blur-sm">
            <p class="text-[10px] text-gray-500 leading-relaxed font-light">
                Powered by Advanced AI Valuation Tech. Market data is real-time estimation.
            </p>
        </div>

        <!-- Error Alert Mejorado -->
        <div id="errorMessage" class="hidden fixed bottom-5 left-4 right-4 z-[100] p-4 bg-red-950/95 border border-red-500 text-white rounded-xl shadow-2xl backdrop-blur-md animate-bounce-in flex items-center">
            <div class="mr-3 p-2 bg-red-900 rounded-full flex-shrink-0">‚ö†Ô∏è</div>
            <div class="flex-1">
                <p class="font-bold text-xs uppercase text-red-400">Diagn√≥stico del Error</p>
                <p id="errorText" class="text-sm font-medium leading-tight text-white"></p>
            </div>
            <button onclick="document.getElementById('errorMessage').classList.add('hidden')" class="ml-3 p-2 text-gray-400 hover:text-white bg-red-900/50 rounded-lg">‚úï</button>
        </div>

    </main>
</div>

<script>
    // ==========================================
    // CONFIGURACI√ìN DE SEGURIDAD
    // ==========================================
    // NOTA: Esta clave funcionar√° SOLO si has a√±adido "https://slotcarhome-star.github.io/*"
    // a las restricciones de tu API Key en Google Cloud Console.
    
    const COMMERCIAL_API_KEY = "AIzaSyBxhtfeKb_sL92jfa-HhCsAlenoYkDCcSs"; 

    // ==========================================

    const VMM_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${COMMERCIAL_API_KEY}`;

    let state = {
        image: null,
        mimeType: null,
        stream: null,
        voices: []
    };

    const $ = (id) => document.getElementById(id);
    const els = {
        imageInput: $('imageInput'),
        preview: $('imagePreview'),
        previewCont: $('imagePreviewContainer'),
        initOpts: $('initialOptions'),
        camSec: $('cameraSection'),
        video: $('cameraStream'),
        canvas: $('cameraCanvas'),
        voiceTog: $('voiceToggle'),
        searchBtn: $('searchButton'),
        btnText: $('buttonText'),
        resCard: $('results-card'),
        loader: $('loadingIndicator'),
        loadMsg: $('loadingMessage'),
        errToast: $('errorMessage'),
        errText: $('errorText'),
        idCar: $('identifiedCar'),
        idBrand: $('carBrand'),
        idCond: $('carCondition'),
        idSec: $('carIdentification'),
        priceSec: $('priceSummary'),
        recP: $('recPrice'),
        minP: $('minPrice'),
        maxP: $('maxPrice'),
        minLink: $('minLink'),
        maxLink: $('maxLink'),
        srcList: $('sourcesList'),
        srcCont: $('sourcesContainer'),
        noRes: $('noResults')
    };

    const initVoice = () => {
        if ('speechSynthesis' in window) {
            state.voices = window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = () => state.voices = window.speechSynthesis.getVoices();
        }
    };

    const speak = (txt) => {
        if (!els.voiceTog.checked || !('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel();
        const utt = new SpeechSynthesisUtterance(txt);
        const voice = state.voices.find(v => v.lang === 'es-ES') || state.voices.find(v => v.lang.includes('es'));
        if (voice) utt.voice = voice;
        utt.rate = 1.05;
        window.speechSynthesis.speak(utt);
    };

    const fileToB64 = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
    });

    const handleImage = async (fileBlob) => {
        if (!fileBlob) return;
        try {
            if (els.preview.src.startsWith('blob:')) URL.revokeObjectURL(els.preview.src);
            els.preview.src = URL.createObjectURL(fileBlob);
            els.previewCont.classList.remove('hidden');
            els.initOpts.classList.add('hidden');
            els.camSec.classList.add('hidden');
            els.resCard.classList.add('hidden');
            
            const file = fileBlob instanceof File ? fileBlob : new File([fileBlob], 'capture.jpg', { type: 'image/jpeg' });
            state.image = await fileToB64(file);
            state.mimeType = file.type;
            
            els.searchBtn.disabled = false;
            els.btnText.textContent = "ANALIZAR MERCADO";
            speak("Imagen lista.");
            
            $('statusDot').classList.remove('bg-gray-600', 'bg-red-500');
            $('statusDot').classList.add('bg-green-500');
            
        } catch (e) { showError("Error interno de imagen.", false); }
    };

    const showError = (msg, isCritical = true) => {
        console.error(msg);
        let userMsg = msg;
        
        // Diagn√≥stico inteligente de errores
        if (msg.includes('403')) {
            userMsg = "üö´ ACCESO DENEGADO (403): Tu dominio 'slotcarhome-star.github.io' no est√° autorizado en Google Cloud. A√±√°delo en Credenciales > Restricciones.";
        } else if (msg.includes('400')) {
            userMsg = "‚ùå ERROR DE CLAVE (400): La API Key es inv√°lida o ha caducado. Revisa el c√≥digo.";
        } else if (msg.includes('Failed to fetch')) {
            userMsg = "üåê SIN CONEXI√ìN: Verifica tu internet o si un bloqueador de anuncios est√° cortando la conexi√≥n.";
        } else if (!isCritical) {
             userMsg = "‚ö†Ô∏è Advertencia: " + msg;
        }

        els.errText.textContent = userMsg;
        els.errToast.classList.remove('hidden');
        els.loader.classList.add('hidden');
        if (state.image) els.searchBtn.disabled = false;
        
        // Si es cr√≠tico, dejamos el mensaje visible m√°s tiempo
        setTimeout(() => els.errToast.classList.add('hidden'), isCritical ? 10000 : 5000);
    };

    const startCam = async () => {
        els.initOpts.classList.add('hidden');
        els.previewCont.classList.add('hidden');
        els.camSec.classList.remove('hidden');
        if (state.stream) stopCam();
        try {
            state.stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: { exact: "environment" } } 
            });
            els.video.srcObject = state.stream;
        } catch (e) {
            try {
                state.stream = await navigator.mediaDevices.getUserMedia({ video: true });
                els.video.srcObject = state.stream;
            } catch (err) { 
                resetUI(); 
                alert("Por favor habilita el acceso a la c√°mara para escanear coches."); 
            }
        }
    };

    const stopCam = () => {
        if (state.stream) {
            state.stream.getTracks().forEach(t => t.stop());
            els.video.srcObject = null;
            state.stream = null;
        }
    };

    const capture = () => {
        if (!state.stream) return;
        const ctx = els.canvas.getContext('2d');
        els.canvas.width = els.video.videoWidth;
        els.canvas.height = els.video.videoHeight;
        ctx.drawImage(els.video, 0, 0);
        stopCam();
        els.canvas.toBlob(handleImage, 'image/jpeg', 0.85);
    };

    const resetUI = () => {
        stopCam();
        state.image = null;
        els.imageInput.value = '';
        els.initOpts.classList.remove('hidden');
        els.camSec.classList.add('hidden');
        els.previewCont.classList.add('hidden');
        els.resCard.classList.add('hidden');
        els.searchBtn.disabled = true;
        els.btnText.innerText = "ESPERANDO IMAGEN";
        $('statusDot').classList.remove('bg-green-500');
        $('statusDot').classList.add('bg-gray-600');
    };

    window.startSearch = async () => {
        if (!state.image) return;
        
        if (COMMERCIAL_API_KEY.length < 10) {
            alert("Error: Falta la API KEY en el c√≥digo.");
            return;
        }

        els.resCard.classList.remove('hidden');
        els.loader.classList.remove('hidden');
        els.idSec.classList.add('hidden');
        els.priceSec.classList.add('hidden');
        els.noRes.classList.add('hidden');
        els.srcCont.classList.add('hidden');
        els.srcList.innerHTML = '';
        els.searchBtn.disabled = true;
        
        els.resCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

        try {
            // 1. Identificar
            els.loadMsg.textContent = "ESCANNEANDO MODELO...";
            const carInfo = await identifyCar(state.image);
            
            if (!carInfo.isSlotCar && !carInfo.model) {
                if(carInfo.keywords) carInfo.isSlotCar = true; 
                else throw new Error("Objeto no reconocido como Slot Car.");
            }
            
            els.idCar.textContent = `${carInfo.model}`;
            els.idBrand.textContent = `${carInfo.brand}`;
            
            const conditionText = carInfo.condition || "Usado";
            els.idCond.textContent = `Estado: ${conditionText.toUpperCase()}`;
            els.idSec.classList.remove('hidden');
            
            // 2. Precios
            els.loadMsg.textContent = "ANALIZANDO MERCADO GLOBAL...";
            const platforms = [
                { name: "Wallapop / Vinted", query: `precio ${carInfo.keywords} wallapop vinted` },
                { name: "Mercado Coleccionista", query: `buy ${carInfo.keywords} slot car ebay amazon price` }
            ];

            const results = await Promise.all(platforms.map(p => fetchPrices(p)));
            renderResults(results, carInfo, conditionText);

        } catch (e) { 
            showError(e.message); 
        } 
        finally { els.loader.classList.add('hidden'); els.searchBtn.disabled = false; }
    };

    const identifyCar = async (b64) => {
        const prompt = `Analiza la imagen de este coche de slot. 
        Devuelve JSON: 
        {
            "isSlotCar": true, 
            "brand": "Marca", 
            "model": "Modelo", 
            "keywords": "marca modelo referencia",
            "condition": "Estado visual estimado (Opciones: 'nuevo' (si parece en caja o perfecto), 'bueno' (usado normal), 'malo' (da√±ado o faltas))"
        }. 
        Si no es slot: {"isSlotCar": false}`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: state.mimeType, data: b64 } }] }],
            generationConfig: { responseMimeType: "application/json" }
        };
        const res = await fetch(VMM_MODEL_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        
        if(!res.ok) {
            // Capturamos el c√≥digo de estado para diagn√≥stico
            throw new Error(`Error HTTP ${res.status}`);
        }
        const json = await res.json();
        return JSON.parse(json.candidates[0].content.parts[0].text);
    };

    const fetchPrices = async (platform) => {
        const searchPrompt = `Busca precios en EUR para "${platform.query}". Lista 3 precios concretos encontrados.`;
        const fallbackPrompt = `Estima 3 precios realistas en EUR para "${platform.query}" bas√°ndote en datos hist√≥ricos de mercado.`;

        const payloadWithTools = {
            contents: [{ parts: [{ text: searchPrompt }] }],
            tools: [{ "google_search": {} }]
        };

        const payloadFallback = {
            contents: [{ parts: [{ text: fallbackPrompt }] }]
        };

        try {
            const res = await fetch(VMM_MODEL_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadWithTools) });
            
            if(!res.ok) throw new Error(`HTTP ${res.status}`);

            const json = await res.json();
            
            if (!json.candidates) throw new Error("No candidates");

            return { 
                platform: platform.name, 
                text: json.candidates?.[0]?.content?.parts?.[0]?.text || "", 
                sources: json.candidates?.[0]?.groundingMetadata?.groundingAttributions || [] 
            };
        } catch (e) {
            // Si falla la b√∫squeda (ej. permisos), fallback silencioso a IA
            // PERO si el error es de autenticaci√≥n (403/400), lo propagamos
            if (e.message.includes('403') || e.message.includes('400')) throw e;

            try {
                const res = await fetch(VMM_MODEL_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadFallback) });
                const json = await res.json();
                return { 
                    platform: platform.name + " (Estimado)", 
                    text: json.candidates?.[0]?.content?.parts?.[0]?.text || "", 
                    sources: [] 
                };
            } catch (err2) {
                return { platform: platform.name, text: null, sources: [] };
            }
        }
    };

    const renderResults = (results, carInfo, condition) => {
        let priceData = [];
        let htmlSources = '';
        const regex = /(?:‚Ç¨\s?|EUR\s?)(\d+[\.,]?\d*)|(\d+[\.,]?\d*)\s?(?:‚Ç¨|EUR)/gi;

        results.forEach(res => {
            if (!res.text) return;
            let primaryLink = res.sources.length > 0 ? res.sources[0].web.uri : null;
            let match;
            while ((match = regex.exec(res.text)) !== null) {
                let val = parseFloat((match[1] || match[2]).replace(',', '.'));
                if (!isNaN(val) && val > 5 && val < 2000) {
                    priceData.push({ value: val, link: primaryLink });
                }
            }
            if (res.text.length > 5) {
                const links = res.sources.map(s => s.web?.uri ? `<a href="${s.web.uri}" target="_blank" class="text-blue-400 underline block truncate text-[10px] mt-1 p-1 bg-gray-900 rounded hover:text-white">üîó ${s.web.title}</a>` : '').slice(0, 2).join('');
                htmlSources += `<div class="bg-gray-800 p-3 rounded-lg border-l-2 border-blue-600 shadow-md mb-2"><h5 class="font-bold text-gray-300 text-xs">${res.platform}</h5><p class="text-[10px] text-gray-400 mb-1 leading-snug">${res.text.replace(/\*/g, '').substring(0, 120)}...</p>${links}</div>`;
            }
        });

        if (priceData.length > 0) {
            priceData.sort((a, b) => a.value - b.value);
            if(priceData.length > 4) priceData = priceData.slice(1, -1);
            
            const minVal = priceData[0].value;
            const maxVal = priceData[priceData.length - 1].value;
            const minLink = priceData[0].link;
            const maxLink = priceData[priceData.length - 1].link;

            let recPrice = 0;
            const avg = (minVal + maxVal) / 2;
            
            if (condition.toLowerCase().includes('nuevo')) {
                recPrice = maxVal * 0.95;
            } else if (condition.toLowerCase().includes('bueno')) {
                recPrice = avg;
            } else {
                recPrice = minVal * 1.1;
            }
            recPrice = Math.round(recPrice);

            els.minP.textContent = `${minVal}‚Ç¨`;
            els.maxP.textContent = `${maxVal}‚Ç¨`;
            els.recP.textContent = `${recPrice}‚Ç¨`;

            const setupLink = (el, link) => {
                if (link) { el.href = link; el.classList.remove('hidden'); el.classList.add('inline-block'); } 
                else { el.classList.add('hidden'); }
            };
            setupLink(els.minLink, minLink);
            setupLink(els.maxLink, maxLink);

            els.priceSec.classList.remove('hidden');
            speak(`Tasaci√≥n finalizada. Valor estimado: ${recPrice} euros.`);

        } else {
            els.noRes.classList.remove('hidden');
            speak("Datos insuficientes para tasar este modelo exacto.");
        }

        if (htmlSources) {
            els.srcList.innerHTML = htmlSources;
            els.srcCont.classList.remove('hidden');
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        initVoice();
        $('cameraButton').onclick = startCam;
        $('captureButton').onclick = capture;
        $('cancelCaptureButton').onclick = resetUI;
        $('uploadFileButton').onclick = () => els.imageInput.click();
        $('changePhotoButton').onclick = resetUI;
        $('voiceToggle').onchange = (e) => { $('voiceStatus').textContent = e.target.checked ? 'ON' : 'OFF'; };
        els.imageInput.onchange = (e) => handleImage(e.target.files[0]);
        resetUI();
    });
</script>
</body>
</html>
